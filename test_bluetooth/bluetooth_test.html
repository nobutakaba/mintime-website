<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PWA ç”Ÿä½“èªè¨¼/ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰èªè¨¼ã‚¬ãƒ¼ãƒ‰ä»˜ããƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸</title>
    <style>
        body { font-family: sans-serif; padding: 20px; }
        button { font-size: 1.2rem; padding: 10px; cursor: pointer; }
        pre { background-color: #f4f4f4; padding: 10px; border-radius: 5px; }
        
        /* èªè¨¼ãŒæˆåŠŸã™ã‚‹ã¾ã§ã€ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’éš ã™ */
        #protectedContent { display: none; } 
        
        .loading { color: gray; }
        .error { color: red; font-weight: bold; }
        .success { color: green; font-weight: bold; }
    </style>
</head>
<body onload="checkWebAuthnSupport()">

    <h1>ğŸ”‘ WebAuthn èªè¨¼ã‚¬ãƒ¼ãƒ‰</h1>
    <p id="initialStatus" class="loading">ãƒšãƒ¼ã‚¸ã‚’å®‰å…¨ã«é–‹ããŸã‚ã€èªè¨¼ã‚’è¦æ±‚ã—ã¦ã„ã¾ã™... (Face ID/Touch IDãŒå„ªå…ˆã•ã‚Œã¾ã™)</p>

    <div id="protectedContent">
        <hr>
        <h2>Web Bluetooth API ãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸ï¼ˆèªè¨¼æ¸ˆã¿ï¼‰</h2>
        <p>ä¸‹ã®ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ã€Bluetoothãƒ‡ãƒã‚¤ã‚¹ã®é¸æŠãƒ€ã‚¤ã‚¢ãƒ­ã‚°ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>
        Â 
        <button id="scanButton">1. ãƒ‡ãƒã‚¤ã‚¹ã‚’ã‚¹ã‚­ãƒ£ãƒ³</button>
    
        <hr>
    
        <h2>çµæœ</h2>
        <pre id="result">ï¼ˆã“ã“ã«ãƒ‡ãƒã‚¤ã‚¹æƒ…å ±ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ï¼‰</pre>
    </div>

    <script>
        const protectedContent = document.getElementById('protectedContent');
        const initialStatus = document.getElementById('initialStatus');
        const resultElement = document.getElementById('result');
        const scanButton = document.getElementById('scanButton');
        
        // ğŸš¨ ãƒ‡ãƒ¢ç”¨ã®å›ºå®šå€¤ã€‚æœ¬ç•ªç’°å¢ƒã§ã¯ã‚µãƒ¼ãƒãƒ¼ãŒå‹•çš„ã«ç®¡ç†ã—ã¾ã™ã€‚
        const KNOWN_CREDENTIAL_ID = new Uint8Array([64, 66, 25, 78, 168, 226, 174, 180, 150, 200, 100, 50, 10, 5, 255]); 

        function updateStatus(element, message, isError = false) {
            element.className = isError ? 'error' : 'success';
            element.textContent = message;
        }

        /**
         * ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«è‡ªå‹•ã§WebAuthnèªè¨¼ã‚’å®Ÿè¡Œã™ã‚‹
         */
        async function requireAuthenticationOnLoad() {
            try {
                // èªè¨¼æ™‚ã«ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰å–å¾—ã—ãŸã¨ä»®å®šã™ã‚‹ã‚ªãƒ—ã‚·ãƒ§ãƒ³
                const publicKeyCredentialRequestOptions = {
                    challenge: new Uint8Array([0x10, 0x11, 0x12, 0x13, 0x14, 0x15, 0x16, 0x17, 0x18, 0x19, 0x1a, 0x1b, 0x1c, 0x1d, 0x1e, 0x1f]),
                    rpId: window.location.hostname,
                    allowCredentials: [{
                        type: 'public-key',
                        id: KNOWN_CREDENTIAL_ID, 
                    }],
                    // OSã®å„ªå…ˆé †ä½ï¼ˆç”Ÿä½“èªè¨¼ -> ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰ï¼‰ã«å¾“ã†ã‚ˆã†è¦æ±‚
                    userVerification: 'preferred', 
                    timeout: 60000
                };

                // ğŸ’¡ ç”Ÿä½“èªè¨¼ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãŒè¡¨ç¤ºã•ã‚Œã‚‹
                const assertion = await navigator.credentials.get({
                    publicKey: publicKeyCredentialRequestOptions
                });

                // âœ… èªè¨¼æˆåŠŸ
                updateStatus(initialStatus, "âœ… ç”Ÿä½“èªè¨¼ï¼ˆã¾ãŸã¯ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰ï¼‰ã«æˆåŠŸã—ã¾ã—ãŸã€‚ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚", false);
                protectedContent.style.display = 'block';
                
                setupBluetoothListener(); 

            } catch (error) {
                // âŒ èªè¨¼å¤±æ•— (ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã€æœªç™»éŒ²ãªã©)
                const message = `âŒ èªè¨¼å¤±æ•—: ${error.name} - ${error.message}`;
                updateStatus(initialStatus, message + "\n\nãƒšãƒ¼ã‚¸ã¯ãƒ­ãƒƒã‚¯ã•ã‚ŒãŸã¾ã¾ã§ã™ã€‚\n(èªè¨¼ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå†…ã§ä»£æ›¿ã®ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰å…¥åŠ›ãŒå¯èƒ½ã§ã™ã€‚)", true);
                console.error("Authentication Error:", error);
            }
        }
        
        /**
         * Web Bluetooth APIã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
         */
        function setupBluetoothListener() {
             if (navigator.bluetooth) {
                scanButton.addEventListener('click', scanForDevice);
                resultElement.textContent = "Web Bluetoothæ©Ÿèƒ½ãŒæœ‰åŠ¹ã«ãªã‚Šã¾ã—ãŸã€‚ã‚¹ã‚­ãƒ£ãƒ³ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚";
            } else {
                resultElement.textContent = "ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯Web Bluetooth APIã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“ã€‚";
                scanButton.disabled = true;
            }
        }
        
        /**
         * Web Bluetooth API ã‚¹ã‚­ãƒ£ãƒ³å‡¦ç† (ç°¡ç•¥ç‰ˆ)
         */
        async function scanForDevice() {
            resultElement.textContent = "ã‚¹ã‚­ãƒ£ãƒ³ä¸­... ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚";
            try {
                const device = await navigator.bluetooth.requestDevice({
                    acceptAllDevices: true 
                });
                resultElement.textContent = `âœ… ãƒ‡ãƒã‚¤ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ:\nåå‰: ${device.name || 'åå‰ãªã—'}\nID: ${device.id}`;
            } catch (error) {
                resultElement.textContent = `âŒ ã‚¹ã‚­ãƒ£ãƒ³å¤±æ•—ã¾ãŸã¯ã‚­ãƒ£ãƒ³ã‚»ãƒ«: ${error.message}`;
            }
        }

        /**
         * ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã®åˆæœŸãƒã‚§ãƒƒã‚¯
         */
        function checkWebAuthnSupport() {
            if (window.isSecureContext && navigator.credentials && navigator.credentials.get) {
                requireAuthenticationOnLoad();
            } else {
                updateStatus(initialStatus, "âŒ ã‚¨ãƒ©ãƒ¼: èªè¨¼ã¯HTTPSæ¥ç¶šãŒå¿…è¦ã§ã™ã€‚ã¾ãŸã¯ã€ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯WebAuthnã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“ã€‚", true);
            }
        }

    </script>Â 
</body>
</html>
