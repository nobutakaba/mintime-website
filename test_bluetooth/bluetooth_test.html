<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PWA ç”Ÿä½“èªè¨¼ï¼ˆWebAuthnï¼‰ã‚¬ãƒ¼ãƒ‰ä»˜ããƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸</title>
    <style>
        body { font-family: sans-serif; padding: 20px; }
        button { font-size: 1.1rem; padding: 8px 12px; margin: 5px 0; cursor: pointer; border-radius: 5px; }
        #registerButton { background-color: #28a745; color: white; border: none; }
        #scanButton { background-color: #007bff; color: white; border: none; }
        hr { margin: 20px 0; }
        h2 { border-bottom: 2px solid #eee; padding-bottom: 5px; }
        pre { background-color: #f4f4f4; padding: 15px; border-radius: 5px; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word; }
        
        /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .loading { color: gray; }
        .error { color: red; font-weight: bold; }
        .success { color: green; font-weight: bold; }
        
        /* èªè¨¼ãŒæˆåŠŸã™ã‚‹ã¾ã§ã€Bluetoothã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’éš ã™ */
        #protectedContent { display: none; } 
    </style>
</head>
<body onload="checkWebAuthnSupport()">

    <h1>ğŸ”‘ WebAuthn èªè¨¼ã‚¬ãƒ¼ãƒ‰</h1>
    <p id="initialStatus" class="loading">ãƒšãƒ¼ã‚¸ã‚’å®‰å…¨ã«é–‹ããŸã‚ã€èªè¨¼ã‚’è¦æ±‚ã—ã¦ã„ã¾ã™... (Face ID/Touch ID/ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰)</p>
    
    <button id="registerButton" style="display:none;" onclick="handleRegistration()">0. èªè¨¼æƒ…å ±ã‚’ç™»éŒ² (æœªç™»éŒ²ã®å ´åˆ)</button>
    
    <div id="protectedContent">
        <hr>
        <h2>Web Bluetooth API ãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸ï¼ˆèªè¨¼æ¸ˆã¿ï¼‰</h2>
        <p>ä¸‹ã®ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ã€Bluetoothãƒ‡ãƒã‚¤ã‚¹ã®é¸æŠãƒ€ã‚¤ã‚¢ãƒ­ã‚°ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>
        Â 
        <button id="scanButton">1. ãƒ‡ãƒã‚¤ã‚¹ã‚’ã‚¹ã‚­ãƒ£ãƒ³</button>
    
        <hr>
    
        <h2>çµæœ</h2>
        <pre id="result">ï¼ˆã“ã“ã«ãƒ‡ãƒã‚¤ã‚¹æƒ…å ±ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ï¼‰</pre>
    </div>

    <script>
        const protectedContent = document.getElementById('protectedContent');
        const initialStatus = document.getElementById('initialStatus');
        const registerButton = document.getElementById('registerButton');
        const resultElement = document.getElementById('result');
        const scanButton = document.getElementById('scanButton');
        
        // ğŸš¨ ãƒ‡ãƒ¢ç”¨ã®å›ºå®šå€¤ã€‚æœ¬æ¥ã¯ã‚µãƒ¼ãƒãƒ¼ãŒå‹•çš„ã«ç®¡ç†ãƒ»ç”Ÿæˆã—ã¾ã™ã€‚
        const DUMMY_USER_ID = new Uint8Array([0x4e, 0x61, 0x6d, 0x65, 0x47, 0x65, 0x6e, 0x65]); 

        function updateStatus(element, message, isError = false) {
            element.className = isError ? 'error' : 'success';
            element.textContent = message;
        }

        // ==========================================================
        // 0. ç™»éŒ²å‡¦ç† (Registration) - æ‰‹å‹•å®Ÿè¡Œç”¨
        // ==========================================================
        async function handleRegistration() {
            updateStatus(initialStatus, "ç™»éŒ²å‡¦ç†ã‚’é–‹å§‹... Face ID/Touch IDã‚’ç™»éŒ²ã—ã¾ã™ã€‚", false);
            
            try {
                const publicKeyCredentialCreationOptions = {
                    rp: { name: "My PWA App", id: window.location.hostname },
                    user: {
                        id: DUMMY_USER_ID,
                        name: "demo_user@pwa.com",
                        displayName: "PWA Demo User"
                    },
                    challenge: new Uint8Array([0x99, 0x93, 0x8a, 0x3d, 0x5a, 0x22, 0x7c, 0x8f, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08]), 
                    pubKeyCredParams: [{ type: "public-key", alg: -7 }],
                    timeout: 60000,
                    attestation: 'none'
                };

                await navigator.credentials.create({
                    publicKey: publicKeyCredentialCreationOptions
                });

                updateStatus(initialStatus, "âœ… èªè¨¼æƒ…å ±ãŒæ­£å¸¸ã«ç™»éŒ²ã•ã‚Œã¾ã—ãŸï¼ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦è‡ªå‹•èªè¨¼ã‚’è©¦ã—ã¦ãã ã•ã„ã€‚", false);
                registerButton.style.display = 'none';

            } catch (error) {
                const message = `âŒ ç™»éŒ²å¤±æ•—: ${error.name} - ${error.message}`;
                updateStatus(initialStatus, message + "\n\nå†è©¦è¡Œã™ã‚‹ã‹ã€ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚", true);
                console.error("Registration Error:", error);
            }
        }

        // ==========================================================
        // 1. èªè¨¼å‡¦ç† (Authentication) - ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚è‡ªå‹•å®Ÿè¡Œ
        // ==========================================================
        async function requireAuthenticationOnLoad() {
            try {
                const publicKeyCredentialRequestOptions = {
                    challenge: new Uint8Array([0x10, 0x11, 0x12, 0x13, 0x14, 0x15, 0x16, 0x17, 0x18, 0x19, 0x1a, 0x1b, 0x1c, 0x1d, 0x1e, 0x1f]),
                    rpId: window.location.hostname,
                    
                    // ğŸ’¡ ã€é‡è¦ã€‘ã“ã®ã‚µã‚¤ãƒˆã«ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ä»»æ„ã®ãƒ‘ã‚¹ã‚­ãƒ¼ã‚’è¨±å¯ã—ã¾ã™ã€‚
                    // ã“ã‚Œã«ã‚ˆã‚Šã€QRã‚³ãƒ¼ãƒ‰è¡¨ç¤ºã‚’é¿ã‘ã€ãƒ­ãƒ¼ã‚«ãƒ«èªè¨¼ï¼ˆFace ID/Touch ID/ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰ï¼‰ãŒä¿ƒã•ã‚Œã¾ã™ã€‚
                    allowCredentials: [], 
                    
                    userVerification: 'preferred', 
                    timeout: 60000
                };

                // ğŸ’¡ ç”Ÿä½“èªè¨¼ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãŒè¡¨ç¤ºã•ã‚Œã‚‹
                await navigator.credentials.get({
                    publicKey: publicKeyCredentialRequestOptions
                });

                // âœ… èªè¨¼æˆåŠŸ
                updateStatus(initialStatus, "âœ… èªè¨¼ã«æˆåŠŸã—ã¾ã—ãŸã€‚ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚", false);
                protectedContent.style.display = 'block';
                registerButton.style.display = 'none';
                
                setupBluetoothListener(); 

            } catch (error) {
                // âŒ èªè¨¼å¤±æ•— (ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã€æœªç™»éŒ²ãªã©)
                const message = `âŒ èªè¨¼å¤±æ•—: ${error.name} - ${error.message}`;
                updateStatus(initialStatus, message + "\n\nãƒšãƒ¼ã‚¸ã¯ãƒ­ãƒƒã‚¯ã•ã‚ŒãŸã¾ã¾ã§ã™ã€‚\nèªè¨¼æƒ…å ±ãŒæœªç™»éŒ²ã®å ´åˆã¯ã€ä¸Šã®ã€Œç™»éŒ²ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚", true);
                registerButton.style.display = 'block'; // èªè¨¼å¤±æ•—æ™‚ã€ç™»éŒ²ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
                console.error("Authentication Error:", error);
            }
        }
        
        // ==========================================================
        // 2. Web Bluetooth API æ©Ÿèƒ½
        // ==========================================================
        function setupBluetoothListener() {
             if (navigator.bluetooth) {
                scanButton.addEventListener('click', scanForDevice);
                resultElement.textContent = "Web Bluetoothæ©Ÿèƒ½ãŒæœ‰åŠ¹ã«ãªã‚Šã¾ã—ãŸã€‚ã‚¹ã‚­ãƒ£ãƒ³ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚";
            } else {
                resultElement.textContent = "ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯Web Bluetooth APIã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“ã€‚";
                scanButton.disabled = true;
            }
        }
        
        async function scanForDevice() {
            resultElement.textContent = "ã‚¹ã‚­ãƒ£ãƒ³ä¸­... ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚";
            try {
                const device = await navigator.bluetooth.requestDevice({
                    acceptAllDevices: true 
                });
                resultElement.textContent = `âœ… ãƒ‡ãƒã‚¤ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ:\nåå‰: ${device.name || 'åå‰ãªã—'}\nID: ${device.id}`;
            } catch (error) {
                resultElement.textContent = `âŒ ã‚¹ã‚­ãƒ£ãƒ³å¤±æ•—ã¾ãŸã¯ã‚­ãƒ£ãƒ³ã‚»ãƒ«: ${error.message}`;
            }
        }

        // ==========================================================
        // 3. åˆæœŸãƒã‚§ãƒƒã‚¯ã¨å®Ÿè¡Œ
        // ==========================================================
        function checkWebAuthnSupport() {
            // HTTPSæ¥ç¶šã‹ã¤WebAuthn APIãŒåˆ©ç”¨å¯èƒ½ã‹ãƒã‚§ãƒƒã‚¯
            if (window.isSecureContext && navigator.credentials && navigator.credentials.get) {
                requireAuthenticationOnLoad();
            } else {
                updateStatus(initialStatus, "âŒ ã‚¨ãƒ©ãƒ¼: èªè¨¼ã¯HTTPSæ¥ç¶šãŒå¿…è¦ã§ã™ã€‚ã¾ãŸã¯ã€ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯WebAuthnã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“ã€‚", true);
            }
        }
    </script>Â 
</body>
</html>
