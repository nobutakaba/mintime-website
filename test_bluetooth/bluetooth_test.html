<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web Bluetooth API ãƒ†ã‚¹ãƒˆ</title>
    <style>
        body { font-family: sans-serif; padding: 20px; }
        button { font-size: 1.2rem; padding: 10px; cursor: pointer; background-color: #4CAF50; color: white; border: none; border-radius: 5px; }
        button:hover { background-color: #45a049; }
        hr { margin: 20px 0; }
        h2 { border-bottom: 2px solid #eee; padding-bottom: 5px; }
        pre { background-color: #f4f4f4; padding: 15px; border-radius: 5px; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word; }
        .error { color: red; font-weight: bold; }
        .success { color: green; font-weight: bold; }
    </style>
</head>
<body>

    <h1>ğŸ“± Web Bluetooth API ãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸</h1>
    <p>ä¸‹ã®ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ã€Bluetoothãƒ‡ãƒã‚¤ã‚¹ã®é¸æŠãƒ€ã‚¤ã‚¢ãƒ­ã‚°ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>
    <p>ğŸš¨ **æ³¨æ„: ã“ã®APIã¯HTTPSç’°å¢ƒã§ã®ã¿å‹•ä½œã—ã¾ã™ã€‚**</p>
    
    <button id="scanButton">1. ãƒ‡ãƒã‚¤ã‚¹ã‚’ã‚¹ã‚­ãƒ£ãƒ³</button>

    <hr>

    <h2>çµæœ</h2>
    <pre id="result">ï¼ˆã“ã“ã«ãƒ‡ãƒã‚¤ã‚¹æƒ…å ±ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ï¼‰</pre>

    <script>
        const scanButton = document.getElementById('scanButton');
        const resultElement = document.getElementById('result');

        /**
         * çµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
         * @param {string} message - è¡¨ç¤ºã™ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
         * @param {boolean} isError - ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‹ã©ã†ã‹
         */
        function updateResult(message, isError = false) {
            resultElement.className = isError ? 'error' : (isError === false ? 'success' : '');
            resultElement.textContent = message;
        }

        /**
         * Web Bluetooth API ã‚’ä½¿ã£ã¦ãƒ‡ãƒã‚¤ã‚¹ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã™ã‚‹é–¢æ•°
         */
        async function scanForDevice() {
            updateResult("ã‚¹ã‚­ãƒ£ãƒ³ä¸­... ãƒ‡ãƒã‚¤ã‚¹é¸æŠãƒ€ã‚¤ã‚¢ãƒ­ã‚°ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚");
            
            try {
                // ãƒ–ãƒ©ã‚¦ã‚¶ã«Bluetoothãƒ‡ãƒã‚¤ã‚¹ã®é¸æŠã‚’è¦æ±‚
                const device = await navigator.bluetooth.requestDevice({
                    // æ¤œç´¢å¯¾è±¡ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ¡ä»¶ã‚’ã“ã“ã«è¨˜è¿°ã—ã¾ã™
                    // ãƒ‡ãƒ¢ã®ãŸã‚ã€ä»Šå›ã¯å…¨ã¦ã®BLEãƒ‡ãƒã‚¤ã‚¹ã‚’è¡¨ç¤ºï¼ˆæ¨å¥¨ã¯ã•ã‚Œã¾ã›ã‚“ï¼‰
                    // å®Ÿéš›ã®ã‚¢ãƒ—ãƒªã§ã¯ services: ['battery_service'] ãªã©ã€å¿…è¦ãªã‚‚ã®ã‚’æŒ‡å®šã—ã¾ã™
                    acceptAllDevices: true 
                    // optionalServices: ['battery_service'] // å¿…è¦ã«å¿œã˜ã¦è¿½åŠ 
                });

                // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ‡ãƒã‚¤ã‚¹ã‚’é¸æŠã—ã€æ¥ç¶šãŒæˆåŠŸã—ãŸå ´åˆ
                const deviceDetails = `
âœ… ãƒ‡ãƒã‚¤ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸï¼
---------------------------------
åå‰: ${device.name || 'åå‰ãªã—'}
ID: ${device.id}
æ¥ç¶šæ¸ˆã¿: ${device.gatt.connected ? 'ã¯ã„' : 'ã„ã„ãˆ'}

---
â€»ã“ã‚Œã¯é¸æŠã•ã‚ŒãŸãƒ‡ãƒã‚¤ã‚¹ã®æƒ…å ±ã§ã‚ã‚Šã€æ¥ç¶šå‡¦ç†ã¯è¡Œã‚ã‚Œã¦ã„ã¾ã›ã‚“ã€‚
`;
                updateResult(deviceDetails, false);

            } catch (error) {
                let errorMessage;

                if (error.name === 'NotFoundError') {
                    errorMessage = "ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ‡ãƒã‚¤ã‚¹é¸æŠã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ãŸã‹ã€å¯¾è±¡ãƒ‡ãƒã‚¤ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚";
                } else if (error.name === 'NotAllowedError') {
                    errorMessage = "Web Bluetoothã®æ¨©é™ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸã€‚ã¾ãŸã¯ã€HTTPSç’°å¢ƒã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚";
                } else {
                    errorMessage = `ã‚¹ã‚­ãƒ£ãƒ³ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`;
                }
                
                updateResult(`âŒ ã‚¨ãƒ©ãƒ¼:\n${errorMessage}`, true);
                console.error("Web Bluetooth Error:", error);
            }
        }

        // ãƒœã‚¿ãƒ³ã«ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
        if (navigator.bluetooth) {
            scanButton.addEventListener('click', scanForDevice);
            updateResult("ãƒ–ãƒ©ã‚¦ã‚¶ã¯Web Bluetoothã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã™ã€‚ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚", false);
        } else {
            updateResult("âŒ ã‚¨ãƒ©ãƒ¼: ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯Web Bluetooth APIã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“ã€‚", true);
            scanButton.disabled = true;
        }
    </script>
</body>
</html>
